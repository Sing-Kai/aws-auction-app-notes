# Auction Backend with Serverless Framework and AWS

Implementation of a microservice backend of an auctioninng applicaiton.

### Microsevices:
- Auction Service [GitHub](https://github.com/Sing-Kai/auction-service)
- Auth Service [GitHub](https://github.com/Sing-Kai/auth-service)
- Notification Service [GitHub](https://github.com/Sing-Kai/notification-service)

### Technologies used:
- Serverless Framework
- Nodejs
- AWS
  - API Gateway
  - Lambda Functions
  - DynamoDB
  - Simple Mail Service
  - Simple Queue Service
  - S3 

## Overview of AWS Architecture 

![image](https://user-images.githubusercontent.com/10774349/229365271-c0552e9c-cc62-43aa-a466-c54f1432cc55.png)

### Auction Service

Main service that handles all CRUD operations of Auctins. Consists of API Gateways, Lambda functions, connects to DynamoDB, Event Bridge and SQS 

6 Lambda Functions in total.

5 Lambda requests come from API Gateway, public gate that triggers endpoints like traditional Rest API. All of which get authorized before getting executed:
- createAuction: creates an auction
- getAuctions: gets auctions based on status with queryParams
- getAuction: gets auctin by the auction id
- placeBid: users place a bid on the auction 
- updateAuctionPicture: updated to S3 for storage

Final Lambda: ProcessAuction is triggered by AWS 
- checks whether the time is up with the auction 
- closes the auction 
- emails the seller and bidder if they are successful or not

### Auth Service

Handles uses Auth0 to handle authentication and authorization, authorizes Lambda functions with JSON web token 

Overview Authentication Flow
- user gets authenticated to Auth0 
- Auth0 sends 200 ok with JSON web token
- sends request to API Gateway with Authorization header that has token 
- API gateway calls authorizer 
- autherizer verifies the token against the public key
- if successful then API Gateway will forward request to Lambda Function with JWT containing user details

```
functions:
  createAuction:
    handler: src/handlers/createAuction.handler
    events:
      - http:
          method: POST
          path: /auction
          cors: true
          authorizer: ***{Auth Service ARN here}*** <----
```

How does the the authenticaiton work?

```
const claims = jwt.verify(token, process.env.AUTH0_PUBLIC_KEY);
```

using the jsonwebtoken library to verify a JSON Web Token (JWT) with a public key

- The jsonwebtoken.verify() method is called with two arguments: the JWT token and the public key.
- The token argument is the JWT token that was previously generated by an authorized party and sent to the server.
- The process.env.AUTH0_PUBLIC_KEY argument is the public key that corresponds to the private key used to sign the JWT token.
- The jwt.verify() method decodes the token's header and payload and verifies its signature using the provided public key.
- If the token's signature is valid, the jwt.verify() method returns the decoded claims object, which contains the payload data encoded in the JWT.
- If the token's signature is invalid, the jwt.verify() method will throw an error indicating that the token is not authentic and has been tampered with.

### Notification Service

Auction Service Lambda `processAuction` will sends to Simple Queue Service and this in turn calls a sendMail Lambda which passes email to Simple Email Service

sendMail Lambda set up, here sendMail event's come from mailQueue arn 

```
functions:
  sendMail:
    handler: src/handlers/sendMail.handler
    events:
      - sqs:
          arn: ${self:custom.mailQueue.arn}
          batchSize: 1
```

closedAuction from Auction service calls SQS

```
  const notifySeller = sqs.sendMessage({
    QueueUrl:process.env.MAIL_QUEUE_URL,
    MessageBody: JSON.stringify({
      subject:'Your item has been sold',
      recipient:seller,
      body:`Congratulations! You item has been ${title} has been sold for $${amount}`,
    })
  }).promise()

  const notifyBidder = sqs.sendMessage({
    QueueUrl:process.env.MAIL_QUEUE_URL,
    MessageBody: JSON.stringify({
      subject:'You won an auction!',
      recipient:bidder,
      body:`Congratulations! you got won the bid for ${title} for $${amount}`,
    })
  }).promise()
```

Execution role assigned for this lambda was set up manually by giving it specific SQS and SES. Custom IAM Role was created




